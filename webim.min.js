/*!
 * Webim v5.5
 * http://nextalk.im/
 *
 * Copyright (c) 2014 Arron
 * Released under the MIT, BSD, and GPL Licenses.
 *
 * Date: Mon Nov 3 17:44:12 2014 +0800
 * Commit: 86907d73b45d2f763b5db25743b0759dcb2f1538
 */
(function(o,t,M){function N(a){return W.call(a)==="[object Function]"}function R(a){return W.call(a)==="[object Array]"}function X(a){return a&&W.call(a)==="[object Object]"}function ba(a){return(a||"").replace(/^\s+|\s+$/g,"")}function Y(a,b){var c=false;if(X(b)){a=a||{};for(var d in b){var f=b[d];if(a[d]!=f){c=c||{};c[d]=f}}}return c}function ca(a){var b=[];if(a!=null){var c=a.length;if(c==null||typeof a==="string"||N(a)||a.setInterval)b[0]=a;else for(;c;)b[--c]=a[c]}return b}function u(){var a=
arguments[0]||{},b=1,c=arguments.length,d=false,f;if(typeof a==="boolean"){d=a;a=arguments[1]||{};b=2}if(typeof a!=="object"&&!N(a))a={};for(;b<c;b++)if((f=arguments[b])!=null)for(var g in f){var i=a[g],l=f[g];if(a!==l)if(d&&l&&typeof l==="object"&&!l.nodeType)a[g]=u(d,i||(l.length!=null?[]:{}),l);else if(l!==M)a[g]=l}return a}function F(a,b,c){var d,f=0,g=a.length,i=g===M||N(a);if(c)if(i)for(d in a){if(b.apply(a[d],c)===false)break}else for(;f<g;){if(b.apply(a[f++],c)===false)break}else if(i)for(d in a){if(b.call(a[d],
d,a[d])===false)break}else for(c=a[0];f<g&&b.call(c,f,c)!==false;c=a[++f]);return a}function O(a,b,c){for(var d=[],f=0,g=a.length;f<g;f++)!c!==!b(a[f],f)&&d.push(a[f]);return d}function Z(a,b){for(var c=[],d,f=0,g=a.length;f<g;f++){d=b(a[f],f);if(d!=null)c[c.length]=d}return c.concat.apply([],c)}function I(a){this.type=a;this.timeStamp=(new Date).getTime()}function G(a){this.URL=a;this._setting();this._connect()}function J(a,b){var c=this;b=b||{};var d=c.ws=new WebSocket(a);d.onopen=function(){c.trigger("open",
"success");d.send("subscribe "+b.domain+" "+b.ticket)};d.onclose=function(f){c.trigger("close",[f.data])};d.onmessage=function(f){f=f.data;try{f=f?o.JSON&&o.JSON.parse?o.JSON.parse(f):(new Function("return "+f))():f}catch(g){}c.trigger("message",[f])};d.onerror=function(){c.trigger("error",[])}}function da(a,b,c){if(typeof b!="undefined"){c=c||{};if(b===null){b="";c.expires=-1}var d="";if(c.expires&&(typeof c.expires=="number"||c.expires.toUTCString)){if(typeof c.expires=="number"){d=new Date;d.setTime(d.getTime()+
c.expires*24*60*60*1E3)}else d=c.expires;d="; expires="+d.toUTCString()}var f=c.path?"; path="+c.path:"",g=c.domain?"; domain="+c.domain:"";c=c.secure?"; secure":"";t.cookie=[a,"=",encodeURIComponent(b),d,f,g,c].join("")}else{b=null;if(t.cookie&&t.cookie!=""){c=t.cookie.split(";");for(d=0;d<c.length;d++){f=ba(c[d]);if(f.substring(0,a.length+1)==a+"="){b=decodeURIComponent(f.substring(a.length+1));break}}}return b}}function m(a,b){this.options=u({},m.defaults,b);this._init(a,b)}function ea(a){return a&&
a.split?a.split(","):R(a)?a:parseInt(a)?[parseInt(a)]:[]}function K(a,b,c){function d(f,g){this.data=f;this.options=u({},d.defaults,g);N(this._init)&&this._init()}d.defaults=b;I.on(d);u(d.prototype,c);m[a]=d}function r(a,b){if(typeof a=="string"){a[a]=b;if(b===M)return r[a]}u(r,a)}var W=Object.prototype.toString;I.on=function(){for(var a,b=I.on.prototype,c=0,d=arguments.length;c<d;c++){a=arguments[c].prototype;a.bind=a.addEventListener=b.addEventListener;a.unbind=a.removeEventListener=b.removeEventListener;
a.trigger=a.dispatchEvent=b.dispatchEvent}};I.on.prototype={addEventListener:function(a,b){var c=this.__listeners=this.__listeners||{};c[a]=c[a]||[];c[a].push(b);return this},dispatchEvent:function(a,b){var c=this.__listeners=this.__listeners||{};a=a.type?a:new I(a);c=c[a.type];if(Object.prototype.toString.call(b)==="[object Array]")b.unshift(a);else b=[a,b];if(c)for(var d=0,f=c.length;d<f;d++)c[d].apply(this,b);return this},removeEventListener:function(a,b){var c=this.__listeners=this.__listeners||
{};if(c[a])if(b){c=c[a];for(var d=c.length;d--;)c[d]===b&&c.splice(d,1)}else delete c[a];return this}};var s=function(){function a(h){var e={};for(var n in a.settings)e[n]=a.settings[n];if(h)for(n in h)e[n]=h[n];if(e.dataType==="jsonp")e.type="GET";var q,x,C,H=e.type.toUpperCase(),fa=f.test(H),D,w,ga=o,y;e.url=e.url.replace($,"");e.context=h&&h.context!=null?h.context:e;if(e.data&&e.processData&&typeof e.data!=="string")e.data=b(e.data,e.traditional);var E=v.exec(e.url);n=o.location;E=E&&(E[1]&&E[1]!==
n.protocol||E[2]!==n.host);/https?:/i.test(n.protocol)||(E=false);E=e.forceRemote?true:E;if(e.dataType==="jsonp"&&!E)e.dataType="json";if(e.dataType==="jsonp"){if(H==="GET")i.test(e.url)||(e.url+=(l.test(e.url)?"&":"?")+(e.jsonp||"callback")+"=?");else if(!e.data||!i.test(e.data))e.data=(e.data?e.data+"&":"")+(e.jsonp||"callback")+"=?";e.dataType="json"}if(e.dataType==="json"&&(e.data&&i.test(e.data)||i.test(e.url))){q=e.jsonpCallback||"jsonp"+c++;if(e.data)e.data=(e.data+"").replace(i,"="+q+"$1");
e.url=e.url.replace(i,"="+q+"$1");e.dataType="script";var ha=o[q],S=false;o[q]=function(A){if(!S){S=true;if(Object.prototype.toString.call(ha)==="[object Function]")ha(A);else{o[q]=M;try{delete o[q]}catch(T){}}C=A;p.handleSuccess(e,j,x,C);p.handleComplete(e,j,x,C);D&&D.removeChild(y);w&&w.parentNode&&w.parentNode.removeChild(w)}}}if(e.dataType==="script"&&e.cache===null)e.cache=false;if(e.cache===false&&H==="GET"){var ia=(new Date).getTime(),ja=e.url.replace(k,"$1_="+ia);e.url=ja+(ja===e.url?(l.test(e.url)?
"&":"?")+"_="+ia:"")}if(e.data&&H==="GET")e.url+=(l.test(e.url)?"&":"?")+e.data;e.global&&p.active++;if(e.dataType==="script"&&H==="GET"&&E){h=false;if(q&&e.async&&!d)if(o._fragmentProxy)D=w=t.createDocumentFragment();else{h=true;if(e.url.slice(0,1)=="/")e.url=n.protocol+"//"+n.host+(n.port?":"+n.port:"")+e.url;else if(!/^https?:\/\//i.test(e.url)){n=n.href;H=/([^?#]+)\//.exec(n);e.url=(H?H[1]:n)+"/"+e.url}e.url=e.url.replace("="+q,"=parent."+q);w=t.createElement("iframe");w.style.position="absolute";
w.style.left="-100px";w.style.top="-100px";w.style.height="1px";w.style.width="1px";w.style.visibility="hidden";t.body.insertBefore(w,t.body.firstChild);ga=w.contentWindow}var ka=function(){var A;try{A=ga.document}catch(T){A=o.document}D=D||A.getElementsByTagName("head")[0]||A.documentElement;y=A.createElement("script");if(e.scriptCharset)y.charset=e.scriptCharset;y.src=e.url;if(d)y.async=e.async;if(q)y.onload=y.onerror=y.onreadystatechange=function(){if(!S&&(!this.readyState||this.readyState==="loaded"||
this.readyState==="complete")){S=true;p.handleError(e,j,"error","load error");D&&y.parentNode&&D.removeChild(y);w&&w.parentNode&&w.parentNode.removeChild(w)}};else{var U=false;y.onload=y.onreadystatechange=function(){if(!U&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){U=true;p.handleSuccess(e,j,x,C);p.handleComplete(e,j,x,C);y.onload=y.onreadystatechange=null;D&&y.parentNode&&D.removeChild(y)}}}D.insertBefore(y,D.firstChild)};h?setTimeout(function(){ka()},0):ka();
return M}var P=false,j=e.xhr();if(j){e.username?j.open(H,e.url,e.async,e.username,e.password):j.open(H,e.url,e.async);try{if(e.data!=null&&!fa||h&&h.contentType)j.setRequestHeader("Content-Type",e.contentType);if(e.ifModified){p.lastModified[e.url]&&j.setRequestHeader("If-Modified-Since",p.lastModified[e.url]);p.etag[e.url]&&j.setRequestHeader("If-None-Match",p.etag[e.url])}E||j.setRequestHeader("X-Requested-With","XMLHttpRequest");j.setRequestHeader("Accept",e.dataType&&e.accepts[e.dataType]?e.accepts[e.dataType]+
", */*; q=0.01":e.accepts._default)}catch(na){}if(e.beforeSend&&e.beforeSend.call(e.context,j,e)===false){e.global&&p.active--;j.abort();return false}e.global&&p.triggerGlobal(e,"ajaxSend",[j,e]);var aa=j.onreadystatechange=function(A){if(!j||j.readyState===0||A==="abort"){P||p.handleComplete(e,j,x,C);P=true;if(j)j.onreadystatechange=p.noop}else if(!P&&j&&(j.readyState===4||A==="timeout")){P=true;j.onreadystatechange=p.noop;x=A==="timeout"?"timeout":!p.httpSuccess(j)?"error":e.ifModified&&p.httpNotModified(j,
e.url)?"notmodified":"success";var T;if(x==="success")try{C=p.httpData(j,e.dataType,e)}catch(U){x="parsererror";T=U}if(x==="success"||x==="notmodified")q||p.handleSuccess(e,j,x,C);else p.handleError(e,j,x,T);q||p.handleComplete(e,j,x,C);A==="timeout"&&j.abort();if(e.async)j=null}};try{var la=j.abort;j.abort=function(){j&&la.call&&la.call(j);aa("abort")}}catch(oa){}e.async&&e.timeout>0&&setTimeout(function(){j&&!P&&aa("timeout")},e.timeout);try{j.send(fa||e.data==null?null:e.data)}catch(ma){p.handleError(e,
j,null,ma);p.handleComplete(e,j,x,C)}e.async||aa();return j}}function b(h){var e=[];if(typeof h=="object"){for(var n in h)e[e.length]=encodeURIComponent(n)+"="+encodeURIComponent(h[n]);return e.join("&").replace(B,"+")}return h}var c=(new Date).getTime(),d=typeof t.createElement("script").async==="boolean",f=/^(?:GET|HEAD|DELETE)$/,g=/\S/,i=/\=\?(&|$)/,l=/\?/,k=/([?&])_=[^&]*/,v=/^(\w+:)?\/\/([^\/?#]+)/,B=/%20/g,$=/#.*$/;o._fragmentProxy=false;var Q=t.createDocumentFragment(),z=t.createElement("script");
try{z.appendChild(t.createTextNode("window._fragmentProxy = true"))}catch(L){z.text="window._fragmentProxy = true"}Q.appendChild(z);Q=z=null;a.param=b;var p={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(h,e,n,q){h.error&&h.error.call(h.context,e,n,q);h.global&&p.triggerGlobal(h,"ajaxError",[e,h,q])},handleSuccess:function(h,e,n,q){h.success&&h.success.call(h.context,q,n,e);h.global&&p.triggerGlobal(h,"ajaxSuccess",[e,h])},handleComplete:function(h,e,n){h.complete&&h.complete.call(h.context,
e,n);h.global&&p.triggerGlobal(h,"ajaxComplete",[e,h]);h.global&&p.active--},triggerGlobal:function(){},httpSuccess:function(h){try{return!h.status&&location.protocol==="file:"||h.status>=200&&h.status<300||h.status===304||h.status===1223}catch(e){}return false},httpNotModified:function(h,e){var n=h.getResponseHeader("Last-Modified"),q=h.getResponseHeader("Etag");if(n)p.lastModified[e]=n;if(q)p.etag[e]=q;return h.status===304},httpData:function(h,e,n){var q=h.getResponseHeader("content-type")||"",
x=e==="xml"||!e&&q.indexOf("xml")>=0;h=x?h.responseXML:h.responseText;x&&h.documentElement.nodeName==="parsererror"&&p.error("parsererror");if(n&&n.dataFilter)h=n.dataFilter(h,e);if(typeof h==="string")if(e==="json"||!e&&q.indexOf("json")>=0)h=h?o.JSON&&o.JSON.parse?o.JSON.parse(h):(new Function("return "+h))():h;else if(e==="script"||!e&&q.indexOf("javascript")>=0)if(h&&g.test(h)){e=t.getElementsByTagName("head")[0]||t.documentElement;n=t.createElement("script");n.type="text/javascript";try{n.appendChild(t.createTextNode(h))}catch(C){n.text=
h}e.insertBefore(n,e.firstChild);e.removeChild(n)}return h}};a.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new o.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};a.setup=function(h){if(h)for(var e in h)a.settings[e]=h[e]};if(o.ActiveXObject)a.settings.xhr=
function(){if(o.location.protocol!=="file:")try{return new o.XMLHttpRequest}catch(h){}try{return new o.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}};return a}(),V=o.JSON?o.JSON:function(){function a(d){return c[d]||"\\u00"+Math.floor(d.charCodeAt()/16).toString(16)+(d.charCodeAt()%16).toString(16)}function b(d){switch(Object.prototype.toString.call(d)){case "[object String]":return'"'+d.replace(/[\x00-\x1f\\"]/g,a)+'"';case "[object Array]":for(var f=[],g=d.length,i=0;i<g;i++)f.push(b(d[i]));return"["+
f.join(",")+"]";case "[object Object]":f=[];for(g in d)(i=b(d[g]))&&f.push(b(g)+":"+i);return"{"+f+"}";case "[object Number]":case "[object Boolean]":return String(d);case false:return"null"}return null}var c={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:b,parse:function(d){d=d.toString();if(!d||!d.length)return null;return(new Function("return "+d))()}}}();G.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=G.CLOSED;
this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var a=this;if(a._connecting)return a;a.readyState=G.CONNECTING;a._connecting=true;a._onPolling||o.setTimeout(function(){a._startPolling()},300);return a},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=G.OPEN;this.trigger("open","success")},_onClose:function(a){var b=this;b._setting();setTimeout(function(){b.trigger("close",
[a])},1E3)},_onData:function(a){this.trigger("message",[a])},_onError:function(a){var b=this;b._setting();setTimeout(function(){b.trigger("error",[a])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;s({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(a){var b=this;b._onPolling=false;if(b._connecting)if(a){b._pollingTimes==1&&b._onConnect();b._onData(a);b._failTimes=
0;b._pollTimer=o.setTimeout(function(){b._startPolling()},200)}else return b._onError("error data")},_onPollError:function(a){var b=this;b._onPolling=false;if(b._connecting){b._failTimes++;if(b._pollingTimes==1)b._onError("can not connect.");else if(b._failTimes>1)b._onClose(a);else b._pollTimer=o.setTimeout(function(){b._startPolling()},200)}}};G.CONNECTING=0;G.OPEN=1;G.CLOSED=2;I.on(G);J.prototype={readyState:0,send:function(){},close:function(){this.ws.close()}};J.enable=!!o.WebSocket;J.CONNECTING=
0;J.OPEN=1;J.CLOSED=2;I.on(J);I.on(m);m.csrf_token="";m.OFFLINE=0;m.BEFOREONLINE=1;m.ONLINE=2;u(m.prototype,{state:m.OFFLINE,_init:function(){var a=this.options;this.data={user:{presence:"offline",show:"unavailable"}};this.models={};s.settings.dataType=a.jsonp?"jsonp":"json";this.status=new m.status(null,a);this.setting=new m.setting;this.models.presence=new m.presence;this.buddy=new m.buddy;this.room=new m.room(null,this.data);this.history=new m.history(null,this.data);this._initEvents()},_createConnect:function(){var a=
this,b=a.data.connection;a.connection=a.options.connectionType!="jsonpd"&&b.websocket&&J.enable?new J(b.websocket,b):new G(b.server+(/\?/.test(b)?"&":"?")+s.param({ticket:b.ticket,domain:b.domain}));a.connection.bind("connect",function(){}).bind("message",function(c,d){a.handle(d)}).bind("error",function(){a._stop("connect","Connect Error")}).bind("close",function(){a._stop("connect","Disconnect")})},setUser:function(a){u(this.data.user,a)},_ready:function(a){this.state=m.BEFOREONLINE;this.trigger("beforeOnline",
[a])},_go:function(){var a=this.data,b=this.history,c=this.buddy,d=this.room,f=this.models.presence;this.state=m.ONLINE;b.options.userInfo=a.user;F(a.buddies,function(g,i){b.init("chat",i.id,i.history)});c.set(a.buddies);a.presences?f.set(a.presences):f.set(Z(a.buddies,function(g){var i={};i[g.id]=g.show;return i}));F(a.rooms,function(g,i){b.init("grpchat",i.id,i.history)});d.set(a.rooms);d.options.ticket=a.connection.ticket;this.trigger("online",[a]);this._createConnect();c=[];if(a.new_messages)c=
c.concat(a.new_messages);if(a.offline_messages)c=c.concat(a.offline_messages);if(c&&c.length){F(c,function(g,i){i["new"]=true});this.trigger("message",[c])}},_stop:function(a,b){if(this.state!==m.OFFLINE){this.state=m.OFFLINE;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.models.presence.clear();this.room.clear();this.history.clean();this.trigger("offline",[a,b])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function a(k){var v=
{id:k.from,presence:k.type};if(k.show)v.show=k.show;if(k.nick)v.nick=k.nick;if(k.status)v.status=k.status;return v}function b(k){return k.type=="online"||k.type=="offline"||k.type=="show"}function c(k){return k.type=="grponline"||k.type=="grpoffline"||k.type=="invite"||k.type=="join"||k.type=="leave"}var d=this,f=d.history,g=d.buddy,i=d.models.presence,l=d.room;d.bind("message",function(k,v){for(var B=[],$=v.length,Q=d.data.user.id,z,L,p,h=0;h<$;h++){z=v[h];p=z.type;L=p=="chat"?z.to==Q?z.from:z.to:
z.to;z.id=L;if(p=="chat"&&!z["new"]){L={id:L,presence:"online"};if(z.nick&&z.to==Q)L.nick=z.nick;B.push(L)}}if(B.length){g.presence(B);g.complete()}f.set(v)});d.bind("presence",function(k,v){var B=O(v,b);g.presence(Z(B,a));i.update(B);v=O(v,c);for(B=v.length-1;B>=0;B--)l.onPresence(v[B])})},handle:function(a){if(a.messages&&a.messages.length){for(var b=a.messages,c=[],d=[],f=0;f<b.length;f++){var g=b[f];if(g.body&&g.body.indexOf("webim-event:")==0){g.event=g.body.replace("webim-event:","").split("|,|");
d.push(g)}else c.push(g)}c.length&&this.trigger("message",[c]);d.length&&this.trigger("event",[d])}a.presences&&a.presences.length&&this.trigger("presence",[a.presences]);a.statuses&&a.statuses.length&&this.trigger("status",[a.statuses])},sendMessage:function(a,b){a.ticket=this.data.connection.ticket;this.trigger("sendMessage",[a]);s({type:"post",cache:false,url:r("message"),data:u({csrf_token:m.csrf_token},a),success:b,error:b})},sendStatus:function(a,b){a.ticket=this.data.connection.ticket;this.trigger("sendStatus",
[a]);s({type:"post",cache:false,url:r("status"),data:u({csrf_token:m.csrf_token},a),success:b,error:b})},sendPresence:function(a,b){a.ticket=this.data.connection.ticket;this.data.user.show=a.show;this.status.set("s",a.show);this.trigger("sendPresence",[a]);s({type:"post",cache:false,url:r("presence"),data:u({csrf_token:m.csrf_token},a),success:b,error:b})},online:function(a){var b=this,c=b.status;if(b.state===m.OFFLINE){var d=[],f=[],g=c.get("tabs"),i=c.get("tabIds");i&&i.length&&g&&F(g,function(l){l[0]==
"b"&&d.push(l.slice(2));l[0]=="r"&&f.push(l.slice(2))});a=u({buddy_ids:d.join(","),room_ids:f.join(","),csrf_token:m.csrf_token,show:c.get("s")||"available"},a);b._ready(a);c.set("o",false);c.set("s",a.show);s({type:"post",cache:false,url:r("online"),data:a,success:function(l){if(l)if(l.success){l.user=u(b.data.user,l.user,{presence:"online"});b.data=l;b._go()}else b._stop("online",l.error_msg);else b._stop("online","Not Found")},error:function(){b._stop("online","Not Found")}})}},offline:function(){var a=
this.data;if(this.state!==m.OFFLINE){this.status.set("o",true);this.connection.close();this._stop("offline","offline");s({type:"post",cache:false,url:r("offline"),data:{status:"offline",csrf_token:m.csrf_token,ticket:a.connection.ticket}})}},_deactivate:function(){var a=this.data;!a||!a.connection||!a.connection.ticket||s({type:"get",cache:false,url:r("deactivate"),data:{ticket:a.connection.ticket,csrf_token:m.csrf_token}})}});o.webim=m;u(m,{version:"5.5",defaults:{},log:function(){var a=new Date;
["[",a.getHours(),":",a.getMinutes(),":",a.getSeconds(),"-",a.getMilliseconds(),"]"].join("");if(o&&o.console)o.console.log.apply(null,arguments);else o&&o.runtime&&o.air&&o.air.Introspector&&o.air.Introspector.Console.log.apply(null,arguments)},idsArray:ea,now:function(){return(new Date).getTime()},isFunction:N,isArray:R,isObject:X,trim:ba,makeArray:ca,extend:u,each:F,inArray:function(a,b){for(var c=0,d=b.length;c<d;c++)if(b[c]===a)return c;return-1},grep:O,map:Z,JSON:V,ajax:s,comet:G,socket:J,model:K,
route:r,ClassEvent:I});K("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,msg_auto_pop:true}},{_init:function(){this.data=u({},this.options.data,this.data)},get:function(a){return this.data[a]},set:function(a,b){var c=this,d=a;if(a){if(typeof a=="string"){d={};d[a]=b}var f=c.data,g=Y(f,d);if(g){F(g,function(i,l){c.trigger("update",[i,l])});d=u({},f,d);c.data=d;s({type:"post",url:r("setting"),cache:false,data:{data:V.stringify(d),csrf_token:m.csrf_token}})}}}});K("status",{key:"_webim",
storage:"local",domain:t.domain},{_init:function(){var a=this.data,b=this.options.key,c=this.options.storage=="local"&&o.localStorage;if(c)try{c.setItem("__store_webim__","__store_webim__");if(c.getItem("__store_webim__")=="__store_webim__")this.store=c;c.removeItem("__store_webim__")}catch(d){this.store=M}if(a)this._save(a);else this.data=(a=this.store?this.store.getItem(b):da(b))?V.parse(a):{}},set:function(a,b){var c=a;if(typeof a=="string"){c={};c[a]=b}var d=this.data;Y(d,c)&&this._save(u({},
d,c))},get:function(a){return this.data[a]},clear:function(){this._save({})},_save:function(a){var b=this.options.key,c=this.options.domain;this.data=a;a=V.stringify(a);this.store?this.store.setItem(b,a):da(b,a,{path:"/",domain:c})}});K("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},remove:function(a){var b=this.get(a);if(b){s({type:"post",url:r("remove_buddy"),cache:false,data:{id:a,csrf_token:m.csrf_token},success:function(){}});this.trigger("unsubscribe",
[[b]]);delete this.dataHash[a]}},clear:function(){this.data=[];this.dataHash={}},count:function(a){var b=this.dataHash,c=0,d;for(var f in b)if(X(a)){d=true;for(var g in a)if(a[g]!=b[f][g])d=false;d&&c++}else c++;return c},get:function(a){return this.dataHash[a]},all:function(a){return a?O(this.data,function(b){return b.show!="invisible"&&b.presence=="online"}):this.data},complete:function(){var a=this.dataHash,b=[],c;for(var d in a){c=a[d];if(c.incomplete){c.incomplete=false;b.push(d)}}this.load(b)},
update:function(a){this.load(a)},presence:function(a){var b=this.dataHash;a=R(a)?a:[a];for(var c in a){var d=a[c];d.presence=d.presence=="offline"?"offline":"online";d.incomplete=!b[d.id];if(!d.group&&d.id)d.group=d.id.indexOf("vid:")==0?"visitor":d.group}this.set(a)},load:function(a){a=ea(a);a.length&&s({type:"get",url:r("buddies"),cache:false,data:{ids:a.join(","),csrf_token:m.csrf_token},context:this,success:this.set})},search:function(a,b){var c=this;s({type:"get",url:r("search"),cache:false,
data:{nick:a,csrf_token:m.csrf_token},context:c,success:function(d){c.set(d);setTimeout(b,500)}})},set:function(a){var b=this.data,c=this.dataHash,d={};a=a||[];for(var f=a.length,g,i,l,k=0;k<f;k++){g=a[k];if(l=g.id){if(!c[l]){g.presence=g.presence||"online";g.show=g.show?g.show:g.presence=="offline"?"unavailable":"available";c[l]={};b.push(c[l])}g.incomplete=!!g.incomplete;if(i=Y(c[l],g)){g=i.presence||"update";d[g]=d[g]||[];u(c[l],i);d[g].push(c[l])}}}for(var v in d)this.trigger(v,[d[v]]);this.options.active&&
this.complete()}});K("presence",{},{_init:function(){this.data=this.data||{};this.set(this.data)},get:function(a){return this.data[a]},set:function(a){var b={};for(var c in a){var d=a[c],f="online";if(d=="unavailable"||d=="invisible")f="offline";b[f]=b[f]||[];b[f].push({id:c,show:d})}for(var g in b)this.trigger(g,[b[g]])},update:function(a){for(var b={},c=0;c<a.length;c++){var d=a[c];b[d.from]=d.show}this.set(b)},clear:function(){this.data=[]}});(function(){K("room",{},{_init:function(){this.data=
this.data||[];this.dataHash={}},get:function(a){return this.dataHash[a]},all:function(a){return a?O(this.data,function(b){return b.temporary}):this.data},invite:function(a,b,c,d){var f=this,g=f.options;s({type:"post",cache:false,url:r("invite"),data:{ticket:g.ticket,id:a,nick:b||"",members:c.join(","),csrf_token:m.csrf_token},success:function(i){f.set([i]);f.loadMember(a);d&&d(i)}})},join:function(a,b,c){var d=this,f=d.options;s({type:"post",cache:false,url:r("join"),data:{ticket:f.ticket,id:a,nick:b||
"",csrf_token:m.csrf_token},success:function(g){d.set([g]);d.loadMember(a);c&&c(g)}})},leave:function(a){var b=this,c=b.options,d=b.dataHash[a],f=c.user;d&&s({type:"post",cache:false,url:r("leave"),data:{ticket:c.ticket,id:a,nick:f.nick,temporary:d.temporary,csrf_token:m.csrf_token},success:function(){delete b.dataHash[a];b.trigger("leaved",[a])}})},block:function(a){var b=this,c=b.options,d=b.dataHash[a];if(d&&!d.blocked){d.blocked=true;var f=[];F(b.dataHash,function(g,i){!i.temporary&&i.blocked&&
f.push(i.id)});s({type:"post",cache:false,url:r("block"),data:{ticket:c.ticket,id:a,csrf_token:m.csrf_token},success:function(){b.trigger("blocked",[a,f])}})}},unblock:function(a){var b=this,c=b.options,d=b.dataHash[a];if(d&&d.blocked){d.blocked=false;var f=[];F(b.dataHash,function(g,i){!i.temporary&&i.blocked&&f.push(i.id)});s({type:"post",cache:false,url:r("unblock"),data:{ticket:c.ticket,id:a,csrf_token:m.csrf_token},success:function(){b.trigger("unblocked",[a,f])}})}},set:function(a){var b=this,
c=b.data,d=b.dataHash;F(a,function(f,g){var i=g.id;if(i){g.members=g.members||[];g.all_count=g.members.length;g.count=0;F(g.members,function(l,k){if(k.presence=="online")g.count+=1});if(d[i])u(d[i],g);else{d[i]=g;c.push(g)}b.trigger("updated",d[i])}})},loadMember:function(a){var b=this,c=b.options;s({type:"get",cache:false,url:r("members"),data:{ticket:c.ticket,id:a,csrf_token:m.csrf_token},success:function(d){b.updateMember(a,d)}})},updateMember:function(a,b){var c=this.dataHash[a];if(c){c.memberLoaded=
true;c.members=b;this.set([c])}},onPresence:function(a){var b=a.type;if(a.to&&this.dataHash[a.to]){var c=a.to,d=this.dataHash[c];d&&d.memberLoaded&&this.loadMember(c);if(b=="join")this.trigger("memberJoined",[c,a]);else if(b=="leave")this.trigger("memberLeaved",[c,a]);else if(b=="grponline")this.trigger("memberOnline",[c,a]);else b=="grpoffline"&&this.trigger("memberOffline",[c,a])}},clear:function(){this.data=[];this.dataHash={}}})})();K("history",{},{_init:function(){this.data=this.data||{};this.data.chat=
this.data.chat||{};this.data.grpchat=this.data.grpchat||{}},clean:function(){this.data.chat={};this.data.grpchat={}},get:function(a,b){return this.data[a][b]},set:function(a){var b=this.data,c={chat:{},grpchat:{}};a=ca(a);var d=a.length,f,g,i=this.options.userInfo.id;if(d){for(var l=0;l<d;l++){f=a[l];k=f.type;if((g=k=="chat"?f.to==i?f.from:f.to:f.to)&&k){c[k][g]=c[k][g]||[];c[k][g].push(f)}}for(var k in c)for(g in c[k]){f=c[k][g];if(b[k][g]){b[k][g]=[].concat(b[k][g]).concat(f);this._triggerMsg(k,
g,f)}else this.load(k,g)}}},_triggerMsg:function(a,b,c){this.trigger(a,[b,c])},clear:function(a,b){this.data[a][b]=[];this.trigger("clear",[a,b]);s({url:r("clear"),type:"post",cache:false,data:{type:a,id:b,csrf_token:m.csrf_token}})},download:function(a,b){var c=r("download"),d=t.createElement("iframe"),f=new Date,g=[];f={id:b,type:a,time:(new Date).getTime(),date:f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()};for(var i in f)g[g.length]=encodeURIComponent(i)+"="+encodeURIComponent(f[i]);c+=
(/\?/.test(c)?"&":"?")+g.join("&");d.setAttribute("src",c);d.style.display="none";t.body.appendChild(d)},init:function(a,b,c){if(R(c)){this.data[a][b]=c;this._triggerMsg(a,b,c)}},load:function(a,b){var c=this;c.data[a][b]=[];s({url:r("history"),cache:false,type:"get",data:{type:a,id:b,csrf_token:m.csrf_token},success:function(d){c.init(a,b,d)}})}})})(window,document);
