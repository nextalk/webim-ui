/*!
 * Webim v5.5
 * http://nextalk.im/
 *
 * Copyright (c) 2014 Arron
 * Released under the MIT, BSD, and GPL Licenses.
 *
 * Date: Fri May 23 18:01:08 2014 +0800
 * Commit: ee2a1e4b0f871eec9671603e35f4023d21b51e3a
 */
(function(n,t,L){function M(a){return W.call(a)==="[object Function]"}function P(a){return W.call(a)==="[object Array]"}function X(a){return a&&W.call(a)==="[object Object]"}function ba(a){return(a||"").replace(/^\s+|\s+$/g,"")}function Y(a,b){var c=false;if(X(b)){a=a||{};for(var d in b){var f=b[d];if(a[d]!=f){c=c||{};c[d]=f}}}return c}function ca(a){var b=[];if(a!=null){var c=a.length;if(c==null||typeof a==="string"||M(a)||a.setInterval)b[0]=a;else for(;c;)b[--c]=a[c]}return b}function u(){var a=
arguments[0]||{},b=1,c=arguments.length,d=false,f;if(typeof a==="boolean"){d=a;a=arguments[1]||{};b=2}if(typeof a!=="object"&&!M(a))a={};for(;b<c;b++)if((f=arguments[b])!=null)for(var g in f){var i=a[g],j=f[g];if(a!==j)if(d&&j&&typeof j==="object"&&!j.nodeType)a[g]=u(d,i||(j.length!=null?[]:{}),j);else if(j!==L)a[g]=j}return a}function E(a,b,c){var d,f=0,g=a.length,i=g===L||M(a);if(c)if(i)for(d in a){if(b.apply(a[d],c)===false)break}else for(;f<g;){if(b.apply(a[f++],c)===false)break}else if(i)for(d in a){if(b.call(a[d],
d,a[d])===false)break}else for(c=a[0];f<g&&b.call(c,f,c)!==false;c=a[++f]);return a}function N(a,b,c){for(var d=[],f=0,g=a.length;f<g;f++)!c!==!b(a[f],f)&&d.push(a[f]);return d}function Z(a,b){for(var c=[],d,f=0,g=a.length;f<g;f++){d=b(a[f],f);if(d!=null)c[c.length]=d}return c.concat.apply([],c)}function H(a){this.type=a;this.timeStamp=(new Date).getTime()}function F(a){this.URL=a;this._setting();this._connect()}function I(a,b){var c=this;b=b||{};var d=c.ws=new WebSocket(a);d.onopen=function(){c.trigger("open",
"success");d.send("subscribe "+b.domain+" "+b.ticket)};d.onclose=function(f){c.trigger("close",[f.data])};d.onmessage=function(f){f=f.data;try{f=f?n.JSON&&n.JSON.parse?n.JSON.parse(f):(new Function("return "+f))():f}catch(g){}c.trigger("message",[f])};d.onerror=function(){c.trigger("error",[])}}function da(a,b,c){if(typeof b!="undefined"){c=c||{};if(b===null){b="";c.expires=-1}var d="";if(c.expires&&(typeof c.expires=="number"||c.expires.toUTCString)){if(typeof c.expires=="number"){d=new Date;d.setTime(d.getTime()+
c.expires*24*60*60*1E3)}else d=c.expires;d="; expires="+d.toUTCString()}var f=c.path?"; path="+c.path:"",g=c.domain?"; domain="+c.domain:"";c=c.secure?"; secure":"";t.cookie=[a,"=",encodeURIComponent(b),d,f,g,c].join("")}else{b=null;if(t.cookie&&t.cookie!=""){c=t.cookie.split(";");for(d=0;d<c.length;d++){f=ba(c[d]);if(f.substring(0,a.length+1)==a+"="){b=decodeURIComponent(f.substring(a.length+1));break}}}return b}}function l(a,b){this.options=u({},l.defaults,b);this._init(a,b)}function ea(a){return a&&
a.split?a.split(","):P(a)?a:parseInt(a)?[parseInt(a)]:[]}function K(a,b,c){function d(f,g){this.data=f;this.options=u({},d.defaults,g);M(this._init)&&this._init()}d.defaults=b;H.on(d);u(d.prototype,c);l[a]=d}function r(a,b){if(typeof a=="string"){a[a]=b;if(b===L)return r[a]}u(r,a)}var W=Object.prototype.toString;H.on=function(){for(var a,b=H.on.prototype,c=0,d=arguments.length;c<d;c++){a=arguments[c].prototype;a.bind=a.addEventListener=b.addEventListener;a.unbind=a.removeEventListener=b.removeEventListener;
a.trigger=a.dispatchEvent=b.dispatchEvent}};H.on.prototype={addEventListener:function(a,b){var c=this.__listeners=this.__listeners||{};c[a]=c[a]||[];c[a].push(b);return this},dispatchEvent:function(a,b){var c=this.__listeners=this.__listeners||{};a=a.type?a:new H(a);c=c[a.type];if(Object.prototype.toString.call(b)==="[object Array]")b.unshift(a);else b=[a,b];if(c)for(var d=0,f=c.length;d<f;d++)c[d].apply(this,b);return this},removeEventListener:function(a,b){var c=this.__listeners=this.__listeners||
{};if(c[a])if(b){c=c[a];for(var d=c.length;d--;)c[d]===b&&c.splice(d,1)}else delete c[a];return this}};var s=function(){function a(h){var e={};for(var m in a.settings)e[m]=a.settings[m];if(h)for(m in h)e[m]=h[m];if(e.dataType==="jsonp")e.type="GET";var q,w,A,G=e.type.toUpperCase(),fa=f.test(G),B,v,ga=n,x;e.url=e.url.replace(Q,"");e.context=h&&h.context!=null?h.context:e;if(e.data&&e.processData&&typeof e.data!=="string")e.data=b(e.data,e.traditional);var C=J.exec(e.url);m=n.location;C=C&&(C[1]&&C[1]!==
m.protocol||C[2]!==m.host);/https?:/i.test(m.protocol)||(C=false);C=e.forceRemote?true:C;if(e.dataType==="jsonp"&&!C)e.dataType="json";if(e.dataType==="jsonp"){if(G==="GET")i.test(e.url)||(e.url+=(j.test(e.url)?"&":"?")+(e.jsonp||"callback")+"=?");else if(!e.data||!i.test(e.data))e.data=(e.data?e.data+"&":"")+(e.jsonp||"callback")+"=?";e.dataType="json"}if(e.dataType==="json"&&(e.data&&i.test(e.data)||i.test(e.url))){q=e.jsonpCallback||"jsonp"+c++;if(e.data)e.data=(e.data+"").replace(i,"="+q+"$1");
e.url=e.url.replace(i,"="+q+"$1");e.dataType="script";var ha=n[q],R=false;n[q]=function(z){if(!R){R=true;if(Object.prototype.toString.call(ha)==="[object Function]")ha(z);else{n[q]=L;try{delete n[q]}catch(S){}}A=z;o.handleSuccess(e,k,w,A);o.handleComplete(e,k,w,A);B&&B.removeChild(x);v&&v.parentNode&&v.parentNode.removeChild(v)}}}if(e.dataType==="script"&&e.cache===null)e.cache=false;if(e.cache===false&&G==="GET"){var ia=(new Date).getTime(),ja=e.url.replace(p,"$1_="+ia);e.url=ja+(ja===e.url?(j.test(e.url)?
"&":"?")+"_="+ia:"")}if(e.data&&G==="GET")e.url+=(j.test(e.url)?"&":"?")+e.data;e.global&&o.active++;if(e.dataType==="script"&&G==="GET"&&C){h=false;if(q&&e.async&&!d)if(n._fragmentProxy)B=v=t.createDocumentFragment();else{h=true;if(e.url.slice(0,1)=="/")e.url=m.protocol+"//"+m.host+(m.port?":"+m.port:"")+e.url;else if(!/^https?:\/\//i.test(e.url)){m=m.href;G=/([^?#]+)\//.exec(m);e.url=(G?G[1]:m)+"/"+e.url}e.url=e.url.replace("="+q,"=parent."+q);v=t.createElement("iframe");v.style.position="absolute";
v.style.left="-100px";v.style.top="-100px";v.style.height="1px";v.style.width="1px";v.style.visibility="hidden";t.body.insertBefore(v,t.body.firstChild);ga=v.contentWindow}var ka=function(){var z;try{z=ga.document}catch(S){z=n.document}B=B||z.getElementsByTagName("head")[0]||z.documentElement;x=z.createElement("script");if(e.scriptCharset)x.charset=e.scriptCharset;x.src=e.url;if(d)x.async=e.async;if(q)x.onload=x.onerror=x.onreadystatechange=function(){if(!R&&(!this.readyState||this.readyState==="loaded"||
this.readyState==="complete")){R=true;o.handleError(e,k,"error","load error");B&&x.parentNode&&B.removeChild(x);v&&v.parentNode&&v.parentNode.removeChild(v)}};else{var T=false;x.onload=x.onreadystatechange=function(){if(!T&&(!this.readyState||this.readyState==="loaded"||this.readyState==="complete")){T=true;o.handleSuccess(e,k,w,A);o.handleComplete(e,k,w,A);x.onload=x.onreadystatechange=null;B&&x.parentNode&&B.removeChild(x)}}}B.insertBefore(x,B.firstChild)};h?setTimeout(function(){ka()},0):ka();
return L}var O=false,k=e.xhr();if(k){e.username?k.open(G,e.url,e.async,e.username,e.password):k.open(G,e.url,e.async);try{if(e.data!=null&&!fa||h&&h.contentType)k.setRequestHeader("Content-Type",e.contentType);if(e.ifModified){o.lastModified[e.url]&&k.setRequestHeader("If-Modified-Since",o.lastModified[e.url]);o.etag[e.url]&&k.setRequestHeader("If-None-Match",o.etag[e.url])}C||k.setRequestHeader("X-Requested-With","XMLHttpRequest");k.setRequestHeader("Accept",e.dataType&&e.accepts[e.dataType]?e.accepts[e.dataType]+
", */*; q=0.01":e.accepts._default)}catch(na){}if(e.beforeSend&&e.beforeSend.call(e.context,k,e)===false){e.global&&o.active--;k.abort();return false}e.global&&o.triggerGlobal(e,"ajaxSend",[k,e]);var $=k.onreadystatechange=function(z){if(!k||k.readyState===0||z==="abort"){O||o.handleComplete(e,k,w,A);O=true;if(k)k.onreadystatechange=o.noop}else if(!O&&k&&(k.readyState===4||z==="timeout")){O=true;k.onreadystatechange=o.noop;w=z==="timeout"?"timeout":!o.httpSuccess(k)?"error":e.ifModified&&o.httpNotModified(k,
e.url)?"notmodified":"success";var S;if(w==="success")try{A=o.httpData(k,e.dataType,e)}catch(T){w="parsererror";S=T}if(w==="success"||w==="notmodified")q||o.handleSuccess(e,k,w,A);else o.handleError(e,k,w,S);q||o.handleComplete(e,k,w,A);z==="timeout"&&k.abort();if(e.async)k=null}};try{var la=k.abort;k.abort=function(){k&&la.call&&la.call(k);$("abort")}}catch(oa){}e.async&&e.timeout>0&&setTimeout(function(){k&&!O&&$("timeout")},e.timeout);try{k.send(fa||e.data==null?null:e.data)}catch(ma){o.handleError(e,
k,null,ma);o.handleComplete(e,k,w,A)}e.async||$();return k}}function b(h){var e=[];if(typeof h=="object"){for(var m in h)e[e.length]=encodeURIComponent(m)+"="+encodeURIComponent(h[m]);return e.join("&").replace(aa,"+")}return h}var c=(new Date).getTime(),d=typeof t.createElement("script").async==="boolean",f=/^(?:GET|HEAD|DELETE)$/,g=/\S/,i=/\=\?(&|$)/,j=/\?/,p=/([?&])_=[^&]*/,J=/^(\w+:)?\/\/([^\/?#]+)/,aa=/%20/g,Q=/#.*$/;n._fragmentProxy=false;var y=t.createDocumentFragment(),D=t.createElement("script");
try{D.appendChild(t.createTextNode("window._fragmentProxy = true"))}catch(U){D.text="window._fragmentProxy = true"}y.appendChild(D);y=D=null;a.param=b;var o={noop:function(){},active:0,lastModified:{},etag:{},handleError:function(h,e,m,q){h.error&&h.error.call(h.context,e,m,q);h.global&&o.triggerGlobal(h,"ajaxError",[e,h,q])},handleSuccess:function(h,e,m,q){h.success&&h.success.call(h.context,q,m,e);h.global&&o.triggerGlobal(h,"ajaxSuccess",[e,h])},handleComplete:function(h,e,m){h.complete&&h.complete.call(h.context,
e,m);h.global&&o.triggerGlobal(h,"ajaxComplete",[e,h]);h.global&&o.active--},triggerGlobal:function(){},httpSuccess:function(h){try{return!h.status&&location.protocol==="file:"||h.status>=200&&h.status<300||h.status===304||h.status===1223}catch(e){}return false},httpNotModified:function(h,e){var m=h.getResponseHeader("Last-Modified"),q=h.getResponseHeader("Etag");if(m)o.lastModified[e]=m;if(q)o.etag[e]=q;return h.status===304},httpData:function(h,e,m){var q=h.getResponseHeader("content-type")||"",
w=e==="xml"||!e&&q.indexOf("xml")>=0;h=w?h.responseXML:h.responseText;w&&h.documentElement.nodeName==="parsererror"&&o.error("parsererror");if(m&&m.dataFilter)h=m.dataFilter(h,e);if(typeof h==="string")if(e==="json"||!e&&q.indexOf("json")>=0)h=h?n.JSON&&n.JSON.parse?n.JSON.parse(h):(new Function("return "+h))():h;else if(e==="script"||!e&&q.indexOf("javascript")>=0)if(h&&g.test(h)){e=t.getElementsByTagName("head")[0]||t.documentElement;m=t.createElement("script");m.type="text/javascript";try{m.appendChild(t.createTextNode(h))}catch(A){m.text=
h}e.insertBefore(m,e.firstChild);e.removeChild(m)}return h}};a.settings={url:location.href,global:true,type:"GET",contentType:"application/x-www-form-urlencoded",processData:true,async:true,xhr:function(){return new n.XMLHttpRequest},accepts:{xml:"application/xml, text/xml",html:"text/html",script:"text/javascript, application/javascript",json:"application/json, text/javascript",text:"text/plain",_default:"*/*"}};a.setup=function(h){if(h)for(var e in h)a.settings[e]=h[e]};if(n.ActiveXObject)a.settings.xhr=
function(){if(n.location.protocol!=="file:")try{return new n.XMLHttpRequest}catch(h){}try{return new n.ActiveXObject("Microsoft.XMLHTTP")}catch(e){}};return a}(),V=n.JSON?n.JSON:function(){function a(d){return c[d]||"\\u00"+Math.floor(d.charCodeAt()/16).toString(16)+(d.charCodeAt()%16).toString(16)}function b(d){switch(Object.prototype.toString.call(d)){case "[object String]":return'"'+d.replace(/[\x00-\x1f\\"]/g,a)+'"';case "[object Array]":for(var f=[],g=d.length,i=0;i<g;i++)f.push(b(d[i]));return"["+
f.join(",")+"]";case "[object Object]":f=[];for(g in d)(i=b(d[g]))&&f.push(b(g)+":"+i);return"{"+f+"}";case "[object Number]":case "[object Boolean]":return String(d);case false:return"null"}return null}var c={"\u0008":"\\b","\t":"\\t","\n":"\\n","\u000c":"\\f","\r":"\\r",'"':'\\"',"\\":"\\\\"};return{stringify:b,parse:function(d){d=d.toString();if(!d||!d.length)return null;return(new Function("return "+d))()}}}();F.prototype={readyState:0,send:function(){},_setting:function(){this.readyState=F.CLOSED;
this._onPolling=this._connecting=false;this._pollTimer=null;this._failTimes=this._pollingTimes=0},_connect:function(){var a=this;if(a._connecting)return a;a.readyState=F.CONNECTING;a._connecting=true;a._onPolling||n.setTimeout(function(){a._startPolling()},300);return a},close:function(){this._pollTimer&&clearTimeout(this._pollTimer);this._setting();return this},_onConnect:function(){this.readyState=F.OPEN;this.trigger("open","success")},_onClose:function(a){var b=this;b._setting();setTimeout(function(){b.trigger("close",
[a])},1E3)},_onData:function(a){this.trigger("message",[a])},_onError:function(a){var b=this;b._setting();setTimeout(function(){b.trigger("error",[a])},1E3)},_startPolling:function(){if(this._connecting){this._onPolling=true;this._pollingTimes++;s({url:this.URL,dataType:"jsonp",cache:false,context:this,success:this._onPollSuccess,error:this._onPollError})}},_onPollSuccess:function(a){var b=this;b._onPolling=false;if(b._connecting)if(a){b._pollingTimes==1&&b._onConnect();b._onData(a);b._failTimes=
0;b._pollTimer=n.setTimeout(function(){b._startPolling()},200)}else return b._onError("error data")},_onPollError:function(a){var b=this;b._onPolling=false;if(b._connecting){b._failTimes++;if(b._pollingTimes==1)b._onError("can not connect.");else if(b._failTimes>1)b._onClose(a);else b._pollTimer=n.setTimeout(function(){b._startPolling()},200)}}};F.CONNECTING=0;F.OPEN=1;F.CLOSED=2;H.on(F);I.prototype={readyState:0,send:function(){},close:function(){this.ws.close()}};I.enable=!!n.WebSocket;I.CONNECTING=
0;I.OPEN=1;I.CLOSED=2;H.on(I);H.on(l);l.csrf_token="";l.OFFLINE=0;l.BEFOREONLINE=1;l.ONLINE=2;u(l.prototype,{state:l.OFFLINE,_init:function(){var a=this.options;this.data={user:{presence:"offline",show:"unavailable"}};this.models={};s.settings.dataType=a.jsonp?"jsonp":"json";this.status=new l.status;this.setting=new l.setting;this.models.presence=new l.presence;this.buddy=new l.buddy;this.room=new l.room(null,this.data);this.history=new l.history(null,this.data);this._initEvents()},_createConnect:function(){var a=
this,b=a.data.connection;a.connection=a.options.connectionType!="jsonpd"&&b.websocket&&I.enable?new I(b.websocket,b):new F(b.server+(/\?/.test(b)?"&":"?")+s.param({ticket:b.ticket,domain:b.domain}));a.connection.bind("connect",function(){}).bind("message",function(c,d){a.handle(d)}).bind("error",function(){a._stop("connect","Connect Error")}).bind("close",function(){a._stop("connect","Disconnect")})},setUser:function(a){u(this.data.user,a)},_ready:function(a){this.state=l.BEFOREONLINE;this.trigger("beforeOnline",
[a])},_go:function(){var a=this.data,b=this.history,c=this.buddy,d=this.room,f=this.models.presence;this.state=l.ONLINE;b.options.userInfo=a.user;E(a.buddies,function(g,i){b.init("chat",i.id,i.history)});c.set(a.buddies);a.presences?f.set(a.presences):f.set(Z(a.buddies,function(g){var i={};i[g.id]=g.show;return i}));E(a.rooms,function(g,i){b.init("grpchat",i.id,i.history)});d.set(a.rooms);d.options.ticket=a.connection.ticket;this.trigger("online",[a]);this._createConnect();c=[];if(a.new_messages)c=
c.concat(a.new_messages);if(a.offline_messages)c=c.concat(a.offline_messages);if(c&&c.length){E(c,function(g,i){i["new"]=true});this.trigger("message",[c])}},_stop:function(a,b){if(this.state!==l.OFFLINE){this.state=l.OFFLINE;this.data.user.presence="offline";this.data.user.show="unavailable";this.buddy.clear();this.models.presence.clear();this.room.clear();this.history.clean();this.trigger("offline",[a,b])}},autoOnline:function(){return!this.status.get("o")},_initEvents:function(){function a(j){var p=
{id:j.from,presence:j.type};if(j.show)p.show=j.show;if(j.nick)p.nick=j.nick;if(j.status)p.status=j.status;return p}function b(j){return j.type=="online"||j.type=="offline"||j.type=="show"}function c(j){return j.type=="invite"||j.type=="join"||j.type=="leave"}var d=this,f=d.history,g=d.buddy,i=d.room;d.bind("message",function(j,p){for(var J=[],aa=p.length,Q=d.data.user.id,y,D,U,o=0;o<aa;o++){y=p[o];U=y.type;D=U=="chat"?y.to==Q?y.from:y.to:y.to;y.id=D;if(U=="chat"&&!y["new"]){D={id:D,presence:"online"};
if(y.nick&&y.to==Q)D.nick=y.nick;J.push(D)}}if(J.length){g.presence(J);g.complete()}f.set(p)});d.bind("presence",function(j,p){g.presence(Z(N(p,b),a));p=N(p,c);for(var J=p.length-1;J>=0;J--)i.onPresence(p[J])})},handle:function(a){if(a.messages&&a.messages.length){for(var b=a.messages,c=[],d=[],f=0;f<b.length;f++){var g=b[f];if(g.body&&g.body.indexOf("webim-event:")==0){g.event=g.body.replace("webim-event:","").split("|,|");d.push(g)}else c.push(g)}c.length&&this.trigger("message",[c]);d.length&&
this.trigger("event",[d])}a.presences&&a.presences.length&&this.trigger("presence",[a.presences]);a.statuses&&a.statuses.length&&this.trigger("status",[a.statuses])},sendMessage:function(a,b){a.ticket=this.data.connection.ticket;this.trigger("sendMessage",[a]);s({type:"post",cache:false,url:r("message"),data:u({csrf_token:l.csrf_token},a),success:b,error:b})},sendStatus:function(a,b){a.ticket=this.data.connection.ticket;this.trigger("sendStatus",[a]);s({type:"post",cache:false,url:r("status"),data:u({csrf_token:l.csrf_token},
a),success:b,error:b})},sendPresence:function(a,b){a.ticket=this.data.connection.ticket;this.data.user.show=a.show;this.status.set("s",a.show);this.trigger("sendPresence",[a]);s({type:"post",cache:false,url:r("presence"),data:u({csrf_token:l.csrf_token},a),success:b,error:b})},online:function(a){var b=this,c=b.status;if(b.state===l.OFFLINE){var d=[],f=[],g=c.get("tabs"),i=c.get("tabIds");i&&i.length&&g&&E(g,function(j){j[0]=="b"&&d.push(j.slice(2));j[0]=="r"&&f.push(j.slice(2))});a=u({buddy_ids:d.join(","),
room_ids:f.join(","),csrf_token:l.csrf_token,show:c.get("s")||"available"},a);b._ready(a);c.set("o",false);c.set("s",a.show);s({type:"post",cache:false,url:r("online"),data:a,success:function(j){if(j)if(j.success){j.user=u(b.data.user,j.user,{presence:"online"});b.data=j;b._go()}else b._stop("online",j.error_msg);else b._stop("online","Not Found")},error:function(){b._stop("online","Not Found")}})}},offline:function(){var a=this.data;if(this.state!==l.OFFLINE){this.status.set("o",true);this.connection.close();
this._stop("offline","offline");s({type:"post",cache:false,url:r("offline"),data:{status:"offline",csrf_token:l.csrf_token,ticket:a.connection.ticket}})}},_deactivate:function(){var a=this.data;!a||!a.connection||!a.connection.ticket||s({type:"get",cache:false,url:r("deactivate"),data:{ticket:a.connection.ticket,csrf_token:l.csrf_token}})}});n.webim=l;u(l,{version:"5.5",defaults:{},log:function(){var a=new Date;["[",a.getHours(),":",a.getMinutes(),":",a.getSeconds(),"-",a.getMilliseconds(),"]"].join("");
if(n&&n.console)n.console.log.apply(null,arguments);else n&&n.runtime&&n.air&&n.air.Introspector&&n.air.Introspector.Console.log.apply(null,arguments)},idsArray:ea,now:function(){return(new Date).getTime()},isFunction:M,isArray:P,isObject:X,trim:ba,makeArray:ca,extend:u,each:E,inArray:function(a,b){for(var c=0,d=b.length;c<d;c++)if(b[c]===a)return c;return-1},grep:N,map:Z,JSON:V,ajax:s,comet:F,socket:I,model:K,route:r,ClassEvent:H});K("setting",{data:{play_sound:true,buddy_sticky:true,minimize_layout:true,
msg_auto_pop:true}},{_init:function(){this.data=u({},this.options.data,this.data)},get:function(a){return this.data[a]},set:function(a,b){var c=this,d=a;if(a){if(typeof a=="string"){d={};d[a]=b}var f=c.data,g=Y(f,d);if(g){E(g,function(i,j){c.trigger("update",[i,j])});d=u({},f,d);c.data=d;s({type:"post",url:r("setting"),cache:false,data:{data:V.stringify(d),csrf_token:l.csrf_token}})}}}});K("status",{key:"_webim"},{_init:function(){var a=this.data,b=this.options.key,c=n.localStorage;if(c)try{c.setItem("__store_webim__",
"__store_webim__");if(c.getItem("__store_webim__")=="__store_webim__")this.store=c;c.removeItem("__store_webim__")}catch(d){this.store=L}if(a)this._save(a);else this.data=(a=this.store?this.store.getItem(b):da(b))?V.parse(a):{}},set:function(a,b){var c=a;if(typeof a=="string"){c={};c[a]=b}var d=this.data;Y(d,c)&&this._save(u({},d,c))},get:function(a){return this.data[a]},clear:function(){this._save({})},_save:function(a){var b=this.options.key;this.data=a;a=V.stringify(a);this.store?this.store.setItem(b,
a):da(b,a,{path:"/",domain:t.domain})}});K("buddy",{active:true},{_init:function(){this.data=this.data||[];this.dataHash={};this.set(this.data)},clear:function(){this.data=[];this.dataHash={}},count:function(a){var b=this.dataHash,c=0,d;for(var f in b)if(X(a)){d=true;for(var g in a)if(a[g]!=b[f][g])d=false;d&&c++}else c++;return c},get:function(a){return this.dataHash[a]},all:function(a){return a?N(this.data,function(b){return b.show!="invisible"&&b.presence=="online"}):this.data},complete:function(){var a=
this.dataHash,b=[],c;for(var d in a){c=a[d];if(c.incomplete){c.incomplete=false;b.push(d)}}this.load(b)},update:function(a){this.load(a)},presence:function(a){var b=this.dataHash;a=P(a)?a:[a];for(var c in a){var d=a[c];d.presence=d.presence=="offline"?"offline":"online";d.incomplete=!b[d.id];if(!d.group&&d.id)d.group=d.id.indexOf("vid:")==0?"visitor":d.group}this.set(a)},load:function(a){a=ea(a);a.length&&s({type:"get",url:r("buddies"),cache:false,data:{ids:a.join(","),csrf_token:l.csrf_token},context:this,
success:this.set})},set:function(a){var b=this.data,c=this.dataHash,d={};a=a||[];var f,g;for(var i in a){f=a[i];if(id=f.id){if(!c[id]){f.presence=f.presence||"online";f.show=f.show?f.show:f.presence=="offline"?"unavailable":"available";c[id]={};b.push(c[id])}f.incomplete=!!f.incomplete;if(g=Y(c[id],f)){f=g.presence||"update";d[f]=d[f]||[];u(c[id],g);d[f].push(c[id])}}}for(var j in d)this.trigger(j,[d[j]]);this.options.active&&this.complete()}});K("presence",{},{_init:function(){this.data=this.data||
{};this.set(this.data)},get:function(a){return this.data[a]},set:function(a){var b={};for(var c in a){var d=a[c],f="online";if(d=="unavailable"||d=="invisible")f="offline";b[f]=b[f]||[];b[f].push({id:c,show:d})}for(var g in b)this.trigger(g,[b[g]])},clear:function(){this.data=[]}});(function(){K("room",{},{_init:function(){this.data=this.data||[];this.dataHash={}},get:function(a){return this.dataHash[a]},all:function(a){return a?N(this.data,function(b){return b.temporary}):this.data},invite:function(a,
b,c,d){var f=this,g=f.options;s({type:"post",cache:false,url:r("invite"),data:{ticket:g.ticket,id:a,nick:b||"",members:c.join(","),csrf_token:l.csrf_token},success:function(i){f.set([i]);f.loadMember(a);d&&d(i)}})},join:function(a,b,c){var d=this,f=d.options;s({type:"post",cache:false,url:r("join"),data:{ticket:f.ticket,id:a,nick:b||"",csrf_token:l.csrf_token},success:function(g){d.set([g]);d.loadMember(a);c&&c(g)}})},leave:function(a){var b=this,c=b.options,d=b.dataHash[a],f=c.user;d&&s({type:"post",
cache:false,url:r("leave"),data:{ticket:c.ticket,id:a,nick:f.nick,temporary:d.temporary,csrf_token:l.csrf_token},success:function(){delete b.dataHash[a];b.trigger("leaved",[a])}})},block:function(a){var b=this,c=b.options,d=b.dataHash[a];if(d&&!d.blocked){d.blocked=true;var f=[];E(b.dataHash,function(g,i){!i.temporary&&i.blocked&&f.push(i.id)});s({type:"post",cache:false,url:r("block"),data:{ticket:c.ticket,id:a,csrf_token:l.csrf_token},success:function(){b.trigger("blocked",[a,f])}})}},unblock:function(a){var b=
this,c=b.options,d=b.dataHash[a];if(d&&d.blocked){d.blocked=false;var f=[];E(b.dataHash,function(g,i){!i.temporary&&i.blocked&&f.push(i.id)});s({type:"post",cache:false,url:r("unblock"),data:{ticket:c.ticket,id:a,csrf_token:l.csrf_token},success:function(){b.trigger("unblocked",[a,f])}})}},set:function(a){var b=this,c=b.data,d=b.dataHash;E(a,function(f,g){var i=g.id;if(i){g.members=g.members||[];g.all_count=g.members.length;g.count=0;E(g.members,function(j,p){if(p.presence=="online")g.count+=1});
if(d[i])u(d[i],g);else{d[i]=g;c.push(g)}b.trigger("updated",d[i])}})},loadMember:function(a){var b=this,c=b.options;s({type:"get",cache:false,url:r("members"),data:{ticket:c.ticket,id:a,csrf_token:l.csrf_token},success:function(d){b.updateMember(a,d)}})},updateMember:function(a,b){var c=this.dataHash[a];if(c){c.memberLoaded=true;c.members=b;this.set([c])}},onPresence:function(a){var b=a.type;if(b=="join"||b=="leave"){var c=a.to||a.status,d=this.dataHash[c];d&&d.memberLoaded&&this.loadMember(c);b==
"join"?this.trigger("memberJoined",[c,a]):this.trigger("memberLeaved",[c,a])}},clear:function(){this.data=[];this.dataHash={}}})})();K("history",{},{_init:function(){this.data=this.data||{};this.data.chat=this.data.chat||{};this.data.grpchat=this.data.grpchat||{}},clean:function(){this.data.chat={};this.data.grpchat={}},get:function(a,b){return this.data[a][b]},set:function(a){var b=this.data,c={chat:{},grpchat:{}};a=ca(a);var d=a.length,f,g,i=this.options.userInfo.id;if(d){for(var j=0;j<d;j++){f=
a[j];p=f.type;if((g=p=="chat"?f.to==i?f.from:f.to:f.to)&&p){c[p][g]=c[p][g]||[];c[p][g].push(f)}}for(var p in c)for(g in c[p]){f=c[p][g];if(b[p][g]){b[p][g]=[].concat(b[p][g]).concat(f);this._triggerMsg(p,g,f)}else this.load(p,g)}}},_triggerMsg:function(a,b,c){this.trigger(a,[b,c])},clear:function(a,b){this.data[a][b]=[];this.trigger("clear",[a,b]);s({url:r("clear"),type:"post",cache:false,data:{type:a,id:b,csrf_token:l.csrf_token}})},download:function(a,b){var c=r("download"),d=t.createElement("iframe"),
f=new Date,g=[];f={id:b,type:a,time:(new Date).getTime(),date:f.getFullYear()+"-"+(f.getMonth()+1)+"-"+f.getDate()};for(var i in f)g[g.length]=encodeURIComponent(i)+"="+encodeURIComponent(f[i]);c+=(/\?/.test(c)?"&":"?")+g.join("&");d.setAttribute("src",c);d.style.display="none";t.body.appendChild(d)},init:function(a,b,c){if(P(c)){this.data[a][b]=c;this._triggerMsg(a,b,c)}},load:function(a,b){var c=this;c.data[a][b]=[];s({url:r("history"),cache:false,type:"get",data:{type:a,id:b,csrf_token:l.csrf_token},
success:function(d){c.init(a,b,d)}})}})})(window,document);
